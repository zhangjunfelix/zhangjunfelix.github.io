<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Power analysis | Jun Zhang</title>
<meta name="keywords" content="">
<meta name="description" content="
1. notes to Green et al. (2016)

Example dataset

step 1: fitting a model
step 2: a simple power analysis
step 3: running the power analysis
Increasing the sample size
Power analysis at a range of sample sizes
Varying the number and size of groups
Increasing the size within groups




2 Power analysis from scratch
3. Power analysis with simr for LMMs
4. Power analysis with simr for multilevel data
5. Power analysis with actual datasets from my own study

1. notes to Green et al. (2016)
https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12504">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/tool/statistics/poweranalysis/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/tool/statistics/poweranalysis/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
  onload="renderMathInElement(document.body, {
    delimiters: [
      {left: '$$', right: '$$', display: true},
      {left: '$', right: '$', display: false}
    ]
  });">
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Jun Zhang (Alt + H)">Jun Zhang</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/teaching/" title="Teaching">
                    <span>Teaching</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tool/" title="Toolbox">
                    <span>Toolbox</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Power analysis
    </h1>
    <div class="post-meta"><span title='2024-08-10 00:00:00 +0000 UTC'>August 10, 2024</span>&nbsp;·&nbsp;18 min

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-notes-to-green-et-al-2016">1. notes to Green et al. (2016)</a>
      <ul>
        <li><a href="#example-dataset">Example dataset</a></li>
      </ul>
    </li>
    <li><a href="#2-power-analysis-from-scratch">2 Power analysis from scratch</a></li>
    <li><a href="#3-power-analysis-with-simr-for-lmms">3. Power analysis with <code>simr</code> for LMMs</a></li>
    <li><a href="#4-power-analysis-with-simr-for-multilevel-data">4. Power analysis with <code>simr</code> for multilevel data</a></li>
    <li><a href="#5-power-analysis-with-actual-datasets-from-my-own-study">5. Power analysis with actual datasets from my own study</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><ul>
<li><a href="#1-notes-to-green-et-al-2016">1. notes to Green et al. (2016)</a>
<ul>
<li><a href="#example-dataset">Example dataset</a>
<ul>
<li><a href="#step-1-fitting-a-model">step 1: fitting a model</a></li>
<li><a href="#step-2-a-simple-power-analysis">step 2: a simple power analysis</a></li>
<li><a href="#step-3-running-the-power-analysis">step 3: running the power analysis</a></li>
<li><a href="#increasing-the-sample-size">Increasing the sample size</a></li>
<li><a href="#power-analysis-at-a-range-of-sample-sizes">Power analysis at a range of sample sizes</a></li>
<li><a href="#varying-the-number-and-size-of-groups">Varying the number and size of groups</a></li>
<li><a href="#increasing-the-size-within-groups">Increasing the size within groups</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-power-analysis-from-scratch">2 Power analysis from scratch</a></li>
<li><a href="#3-power-analysis-with-simr-for-lmms">3. Power analysis with <code>simr</code> for LMMs</a></li>
<li><a href="#4-power-analysis-with-simr-for-multilevel-data">4. Power analysis with <code>simr</code> for multilevel data</a></li>
<li><a href="#5-power-analysis-with-actual-datasets-from-my-own-study">5. Power analysis with actual datasets from my own study</a></li>
</ul>
<h2 id="1-notes-to-green-et-al-2016">1. notes to Green et al. (2016)<a hidden class="anchor" aria-hidden="true" href="#1-notes-to-green-et-al-2016">#</a></h2>
<p><a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12504">https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12504</a></p>
<ul>
<li>
<p>simr works with any LMMs or GLMMs that can be fit with either <code>lmer</code> or <code>glmer</code> from <code>LME4</code>.</p>
</li>
<li>
<p>work flow</p>
<ol>
<li>a model fitted with LME4 (based on an analysis of data from a pilot study, or create artificial pilot data from scratch )</li>
<li>simulate <em><strong>new values for the response variable</strong></em> using the model provided;</li>
<li>refit the model to the simulated response</li>
<li>apply a statistical test to the simulated fit.</li>
</ol>
<p>In this setup the tested effect is known to exist, and so every positive test is a true positive and every negative test is a Type II error. The power of the test can be calculated from the number of successes and failures at step 4.</p>
</li>
</ul>
<h3 id="example-dataset">Example dataset<a hidden class="anchor" aria-hidden="true" href="#example-dataset">#</a></h3>
<p>The tutorial uses the simdata data set which is included in the package. The data set is representative of environmental monitoring data, with a response variable z (e.g. bird abundance) measured at <code>10 levels of the continuous fixed effect variable x</code> (e.g. study year) for <code>three groups g</code> (e.g. study site). There is also a continuous response variable y, which is not used in this tutorial.</p>
<h4 id="step-1-fitting-a-model">step 1: fitting a model<a hidden class="anchor" aria-hidden="true" href="#step-1-fitting-a-model">#</a></h4>
<p>We start by fitting a very simple <code>Poisson mixed effects model</code> in lme4 to the <code>simdata</code> data set. In this case we have a random intercept model, where each group (g) has its own intercept but the groups share a common trend.</p>
<pre tabindex="0"><code>library(simr)
model1 &lt;- glmer(z ~ x + (1|g), family=&#34;poisson&#34;, data=simdata)
summary(model1)
fixef(model1)
</code></pre><pre><code>Fixed effects:
             Estimate Std. Error z value Pr(&gt;¦z¦) 
(Intercept)  1.54079 0.27173 5.670 1.43e-08 ***
x            -0.11481 0.03955 - 2.903 0.0037 ** 
</code></pre>
<p>The effect size for x is -0.11481. It is significant at the 0.01 level using the default z-test.</p>
<h4 id="step-2-a-simple-power-analysis">step 2: a simple power analysis<a hidden class="anchor" aria-hidden="true" href="#step-2-a-simple-power-analysis">#</a></h4>
<p>Suppose that we wanted to replicate this study. If the effect is real, would we have enough power to expect a positive result?</p>
<ul>
<li>specifying an effect size
Before starting a power analysis, it is important to consider what sort of effect size you are interested in. Power generally increases with effect size, with larger effects being easier to detect.</li>
</ul>
<p>For this example, we will consider the power to detect a slope of −0·05.</p>
<p>Since this example only focuses on the variable x, We change the size of the fixed effect (i.e., slope) for the variable x from −0·11 to −0·05 (as -0.05 &gt; -0.11),  as follows:</p>
<pre tabindex="0"><code>fixef(model1)[&#34;x&#34;] &lt;- -0.05
</code></pre><h4 id="step-3-running-the-power-analysis">step 3: running the power analysis<a hidden class="anchor" aria-hidden="true" href="#step-3-running-the-power-analysis">#</a></h4>
<pre tabindex="0"><code>powerSim(model1)
</code></pre><p>output:</p>
<pre tabindex="0"><code>## Power for predictor &#39;x&#39;, (95% confidence interval):   
## ***32.40%*** (29.50, 35.40)   
## 
## Test: z-test    
      Effect size for x is -0.050   
## 
## Based on 1000 simulations, (0 warnings, 0 errors)      
## alpha = 0.05, nrow = ***30***    
## 
## Time elapsed: 0 h 2 m 20 s    
</code></pre><p>The power to reject the null hypothesis of zero trend in x is about 33%, given this particular setup. This would almost always be considered insufficient; traditionally 80% power is considered adequate.</p>
<h4 id="increasing-the-sample-size">Increasing the sample size<a hidden class="anchor" aria-hidden="true" href="#increasing-the-sample-size">#</a></h4>
<p>A small pilot study often will not have enough power to detect a small effect, but a larger study might.</p>
<p>In simr, the extend function can be used to add rows to a data frame.</p>
<p>The along argument specifies which variable is being extended, and n specifies how many levels to replace it with.</p>
<p>The pilot study had observations at 10 values of x, representing for example study years 1 through 10. In this step, we will calculate the effect of increasing this to 20 years.</p>
<pre tabindex="0"><code>model2 &lt;- extend(model1, along=&#34;x&#34;, n=20)
powerSim(model2)
</code></pre><p>output:</p>
<pre tabindex="0"><code>## Power for predictor &#39;x&#39;, (95% confidence interval):   
##      ***95.50%*** (94.02, 96.70)   
##    
##Test: z-test    
##      Effect size for x is -0.050          
##
## Based on 1000 simulations, (1 warning, 0 errors)     
## alpha = 0.05, nrow = ***60***    
##
## Time elapsed: 0 h 2 m 33 s   
</code></pre><h4 id="power-analysis-at-a-range-of-sample-sizes">Power analysis at a range of sample sizes<a hidden class="anchor" aria-hidden="true" href="#power-analysis-at-a-range-of-sample-sizes">#</a></h4>
<p>When data collection is costly, the user might want to collect only as much data as are needed to achieve a certain level of statistical power. The powerCurve function in simr can be used to explore trade-offs between sample size and power.</p>
<ul>
<li>Identifying the Minimum Sample Size Required</li>
</ul>
<p>In the previous example, we found very high power when observations were taken at 20 values of the variable x. Could we reduce that number while keeping our power above the usual 80% threshold?</p>
<p>Use powerCurve(): This function runs powerSim over a range of sample sizes.</p>
<pre tabindex="0"><code>pc2 &lt;- powerCurve(model2)

print(pc2)

plot(pc2)
</code></pre><p>output:</p>
<p><a href="https://besjournals.onlinelibrary.wiley.com/cms/asset/250da79b-4849-4cce-b2d3-d7efc050e495/mee312504-fig-0002-m.png">https://besjournals.onlinelibrary.wiley.com/cms/asset/250da79b-4849-4cce-b2d3-d7efc050e495/mee312504-fig-0002-m.png</a></p>
<p>This analysis suggests that the study would have to run for 16 years to have ≥80% power to detect an effect of the specified size.</p>
<h4 id="varying-the-number-and-size-of-groups">Varying the number and size of groups<a hidden class="anchor" aria-hidden="true" href="#varying-the-number-and-size-of-groups">#</a></h4>
<p>In some cases, it is not possible to add number of observations. Thus, increasing the number of study sites or the number of measurements at each site might be a better option.</p>
<p>In the following codes, we pass the variable <em>g</em> to the <em>along</em> argument and increase it from 3 to 15.</p>
<pre tabindex="0"><code>model3 &lt;- extend(model1, along=&#34;g&#34;, n=15)
pc3 &lt;- powerCurve(model3, along=&#34;g&#34;)
plot(pc3) 
</code></pre><p>output:</p>
<p><a href="https://besjournals.onlinelibrary.wiley.com/cms/asset/2186785e-dd4e-4547-a3a2-d9a2c15862db/mee312504-fig-0003-m.jpg">https://besjournals.onlinelibrary.wiley.com/cms/asset/2186785e-dd4e-4547-a3a2-d9a2c15862db/mee312504-fig-0003-m.jpg</a></p>
<p>Therefore, to reach 80% power, we would need at least 11 sites.</p>
<h4 id="increasing-the-size-within-groups">Increasing the size within groups<a hidden class="anchor" aria-hidden="true" href="#increasing-the-size-within-groups">#</a></h4>
<p>use <em>within</em> argument</p>
<p>In model1, each group has only one observation at eachlevel of x and g. We can extend this to 5 observations per site per year.</p>
<pre tabindex="0"><code>model4 &lt;- extend(model1, within=&#34;x+g&#34;, n=5)
pc4 &lt;- powerCurve(model4, within=&#34;x+g&#34;, breaks=1:5)
print(pc4)

plot(pc4)
</code></pre><p>output of print(pc4):</p>
<pre tabindex="0"><code>## Power for predictor &#39;x&#39;, (95% confidence interval),   
## by number of observations within x+g:   
## 1: 33.90% (30.97, 36.93) - 30 rows    
## 2: 58.00% (54.87, 61.08) - 60 rows    
## 3: 74.40% (71.58, 77.08) - 90 rows    
## 4: 86.30% (84.01, 88.37) - 120 rows    
## 5: 91.80% (89.92, 93.43) - 150 rows    
## 
## Time elapsed: 0 h 11 m 35 s  
</code></pre><h2 id="2-power-analysis-from-scratch">2 Power analysis from scratch<a hidden class="anchor" aria-hidden="true" href="#2-power-analysis-from-scratch">#</a></h2>
<p>If pilot data is not available, simr can be used to create lme4 objects from scratch as a starting point.</p>
<p>This requires more paramters to be specified by the user. Values for these parameters might come from the literature or the user’s own knowledge and experience.</p>
<ul>
<li>Covariates and parameters</li>
</ul>
<ol>
<li>First set up some covariates with expand.grid.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>x <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>g <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;c&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">expand.grid</span>(x<span style="color:#f92672">=</span>x, g<span style="color:#f92672">=</span>g)
</span></span></code></pre></div><ol start="2">
<li>Specify some fixed and random parameters.</li>
</ol>
<pre tabindex="0"><code>
b &lt;- c(2, -0.1) # fixed intercept and slope

V1 &lt;- 0.5 # random intercept variance

V2 &lt;- matrix(c(0.5,0.05,0.05,0.1), 2) # random intercept and slope 

variance-covariance matrix

s &lt;- 1 # residual variance
</code></pre><ul>
<li>Build a model object</li>
</ul>
<ol>
<li>build an artificial lme4 object</li>
</ol>
<p>1.1  Use the <code>makeLmer</code> function</p>
<pre tabindex="0"><code>model1 &lt;- makeLmer(y ~ x + (1|g), fixef=b, VarCorr=V1, sigma=s, data=X)
print(model1)
</code></pre><p>output:</p>
<pre tabindex="0"><code>
## Linear mixed model fit by REML [&#39;lmerMod&#39;]   
## Formula: y ~ x + (1 | g)  
##    Data: X  
## REML criterion at convergence: 92.7639   
## Random effects:   
##  Groups   Name        Std.Dev.   
##  g        (Intercept) 0.7071    
##  Residual             1.0000    
## Number of obs: 30, groups:  g, 3    
## Fixed Effects:    
## (Intercept)           x        
##         2.0         -0.1       
</code></pre><p>Use the <code>makeGlmer</code> function</p>
<pre tabindex="0"><code>model2 &lt;- makeGlmer(z ~ x + (x|g), family=&#34;poisson&#34;, fixef=b, VarCorr=V2, data=X)
print(model2)
</code></pre><p>output:</p>
<pre tabindex="0"><code>## Generalized linear mixed model fit by maximum likelihood (Laplace     
##   Approximation) [glmerMod]           
##  Family: poisson  ( log )           
## Formula: z ~ x + (x | g)            
##    Data: X         
##      AIC      BIC   logLik deviance df.resid          
##  73.5828  80.5888 -31.7914  63.5828       25           
## Random effects:          
##  Groups Name        Std.Dev. Corr         
##  g      (Intercept) 0.7071                     
##         x           0.3162   0.22          
## Number of obs: 30, groups:  g, 3          
## Fixed Effects:          
## (Intercept)            x          
##         2.0         -0.1         
</code></pre><ul>
<li>Start the power analysis</li>
</ul>
<p>Now we have “pilot” models, which can be used with simr.</p>
<pre tabindex="0"><code>powerSim(model1, nsim=20)
</code></pre><pre tabindex="0"><code>## Power for predictor &#39;x&#39;, (95% confidence interval):
## 35.00% (15.39, 59.22)
## 
## Test: Kenward Roger (package pbkrtest)
##       Effect size for x is -0.10
## 
## Based on 20 simulations, (0 warnings, 0 errors)
## alpha = 0.05, nrow = 30
## 
## Time elapsed: 0 h 0 m 3 s
</code></pre><pre tabindex="0"><code>powerSim(model2, nsim=20)
</code></pre><pre tabindex="0"><code>## Power for predictor &#39;x&#39;, (95% confidence interval):   
## 10.00% ( 1.23, 31.70)  
##     
## Test: z-test    
##       Effect size for x is -0.10   
##     
## Based on 20 simulations, (7 warnings, 0 errors)   
## alpha = 0.05, nrow = 30   
##    
## Time elapsed: 0 h 0 m 4 s    
</code></pre><h2 id="3-power-analysis-with-simr-for-lmms">3. Power analysis with <code>simr</code> for LMMs<a hidden class="anchor" aria-hidden="true" href="#3-power-analysis-with-simr-for-lmms">#</a></h2>
<p>In this part of the workshop you will use simr to determine power / required sample size for linear mixed effects models. The lme4 package is used for modelling.</p>
<ul>
<li>data</li>
</ul>
<p>(1) When pilot data or other closely related data are available it is best to use them to obtain estimates for fixed and random effects.</p>
<p>(2) When that is not possible, creating an appropriate model with parameters specified directly still allows the simulation to be carried out.</p>
<p>Use information from the literature or previous studies as much as possible.</p>
<ul>
<li>step 1: Create covariates</li>
</ul>
<p>The first step in creating a model for simulation is to create a set of covariates that the model will be based on.</p>
<p>Example study: Children from different <em>classes</em> at a <em>school</em> will be recruited. Each <em>participant</em> will be allocated to either an <em>intervention or a control</em> group. For each participant measurements will be taken at <em>baseline, immediately following the intervention and at follow-up a few weeks later</em>.</p>
<p>We start by setting up a data frame with <em>5 classes</em> and <em>10 participants</em> per class.</p>
<pre tabindex="0"><code>subj &lt;- factor(1:10)      #10 subjects
class_id &lt;- letters[1:5]  #5 classes
time &lt;- 0:2               # 3 test time points
group &lt;- c(&#34;control&#34;, &#34;intervention&#34;)          #2 groups 


subj_full &lt;- rep(subj, 15)  #subj_full这一列10 subjects，每个重复15遍
class_full &lt;- rep(rep(class_id, each=10), 3)  #class_full这一列5 classes，每个重复10遍；然后这50个再重复3遍。
time_full &lt;- rep(time, each=50)  #time_full这一列3 time points，每个重复50遍
group_full &lt;- rep(rep(group, each=5), 15)   #group_full这一列2 groups，每个重复5遍；然后这10个再重复15遍

covars &lt;- data.frame(id=subj_full, class=class_full, treat=group_full, time=factor(time_full))

covars
</code></pre><ul>
<li>
<p>step 2: specify the parameters for the model</p>
<p><strong>y∼treatment+time+treatment×time+(1|class/id)+ϵ</strong></p>
</li>
</ul>
<p>For the purpose of this example parameter values were chosen arbitrarily</p>
<p>based on the above model, the parameters are:    <br>
two fixed effects</p>
<ul>
<li>treat: 2 levels (intervention vs. control)</li>
<li>time: 3 levels (time1 vs. time2 vs. time3) <br>
and random effect</li>
</ul>
<p>thus, we need to specify the following parameters:</p>
<ul>
<li>one intercept</li>
<li>one fixed effect for treat</li>
<li>two fixed effect for time</li>
<li>two interaction effect between treat and time</li>
</ul>
<pre tabindex="0"><code>## Intercept and slopes for intervention, time1, time2, intervention:time1, intervention:time2
fixed &lt;- c(5, 0, 0.1, 0.2, 1, 0.9)

## Random intercepts for participants clustered by class
rand &lt;- list(0.5, 0.1)

## residual variance
res &lt;- 2
</code></pre><ul>
<li>create model</li>
</ul>
<p>The <code>makeLmer</code> function from the <code>simr</code> package allows us to combine all this information to create a fitted lmer model from scratch.</p>
<p><strong><code>makeLmer</code></strong> is for creating a LMM object<br>
<strong><code>makeGlmer</code></strong> is for creating a GLMM object</p>
<pre tabindex="0"><code>model &lt;- makeLmer(y ~ treat*time + (1|class/id), fixef=fixed, VarCorr=rand, sigma=res, data=covars)

model
</code></pre><p>output</p>
<pre tabindex="0"><code>
## Linear mixed model fit by REML [&#39;lmerMod&#39;]     
## Formula: y ~ treat * time + (1 | class/id)   
##    Data: covars    
## REML criterion at convergence: 684.4832      
     
## Random effects:     
##  Groups   Name        Std.Dev.     
##  id:class (Intercept) 0.7071    #0.5的平方根  #上面指定的是variance，SD=sqrt(variance)     
##  class    (Intercept) 0.3162        #0.1的平方根    
##  Residual             2.0000      

## Number of obs: 150, groups:  id:class, 50; class, 5     
## Fixed Effects:      
##             (Intercept)        treatintervention                    time1       
##                     5.0                      0.0                      0.1       
##                   time2  treatintervention:time1  treatintervention:time2      
##                     0.2                      1.0                      0.9     
</code></pre><ul>
<li>Power analysis</li>
</ul>
<p>Once you have a fitted lmer model, whether it was fitted to real data or created from scratch, you can use that to simulate new data and assess the required sample size.</p>
<p>The <strong><code>powerSim</code></strong> function allows us to <em><strong>estimate the power to detect a specific effect</strong></em> in the model.</p>
<p>Here we are interested in the effect of the intervention.</p>
<p><em>Since the treatment variable is part of an interaction we will assess its effect by comparing the model specified above to the the alternative model that doesn’t include a treatment variable.</em></p>
<p>We can provide this model alternative via the <strong><code>fcompare</code></strong> function. This allows us to only specify the fixed effects in the alternative model.</p>
<p>All random effects will be assumed to be the same as in the original model.</p>
<pre tabindex="0"><code>sim_treat &lt;- powerSim(model, nsim=100, test = fcompare(y~time))
sim_treat
</code></pre><p>output:</p>
<pre tabindex="0"><code>## Power for model comparison, (95% confidence interval):      
##       41.00% (31.26, 51.29)       
##       
## Test: Likelihood ratio     
##       Comparison to y ~ time + [re]     
##     
## Based on 100 simulations, (0 warnings, 0 errors)     
## alpha = 0.05, nrow = 150      
##       
## Time elapsed: 0 h 0 m 47 s     
</code></pre><p>notes:
(1) we can also test for the effect of time in the same way.</p>
<pre tabindex="0"><code>sim_time &lt;- powerSim(model, nsim=100, test = fcompare(y~treat))
sim_time
</code></pre><p>(2) We can <strong>adjust the effect size</strong> to suit the analysis, e.g. to compute power for an effect size that is smaller than the one observed in a pilot study, or to study power for a range of effect sizes.</p>
<p>e.g.</p>
<pre tabindex="0"><code>model_large &lt;- model
fixef(model_large)[&#39;treatintervention:time1&#39;] &lt;- 2

sim_treat_large &lt;- powerSim(model_large, nsim=100, test = fcompare(y~time))
sim_treat_large
</code></pre><ul>
<li>Changing the number of classes used in study</li>
</ul>
<p>To study the effect an increase in <strong>sample size</strong> has on our ability to detect the effect of interest we can increase the number of levels for one of the factors in our model.</p>
<p><strong>y∼treatment+time+treatment×time+(1|class/id)+ϵ</strong></p>
<p>This can be achieved with the <em><strong><code>extend</code></strong></em> function. For example, we could increase the number of classes from 5 to 20.</p>
<pre tabindex="0"><code>model_ext_class &lt;- extend(model, along=&#34;class&#34;, n=20)
model_ext_class
</code></pre><p>We can visualise the effect that <strong>varying the number of classes has on the power to detect the intervention effect</strong> by asking simr to plot a power curve.</p>
<pre tabindex="0"><code>sim_treat_class &lt;- powerSim(model_ext_class, nsim=100, test = fcompare(y~time))
sim_treat_class

# visualization
p_curve_treat &lt;- powerCurve(model_ext_class, test=fcompare(y~time), along=&#34;class&#34;)
plot(p_curve_treat)
</code></pre><p>output:<br>
see: <a href="https://humburg.github.io/Power-Analysis/simr_power_analysis.html">https://humburg.github.io/Power-Analysis/simr_power_analysis.html</a></p>
<ul>
<li>Changing the number of participants per class ‼️</li>
</ul>
<p>Instead of increasing the number of classes we could <em><strong>increase the number of participants per class</strong></em>.</p>
<p>This can be achieved with the <strong><code>within</code></strong> argument to <strong><code>extend</code></strong>.</p>
<p>Here we are extending the number of students for each treatment at each time point within each class to 20.</p>
<pre tabindex="0"><code>model_ext_subj &lt;- extend(model, within=&#34;class+treat+time&#34;, n=20)
model_ext_subj
</code></pre><p>note:<br>
<strong>within=&ldquo;class+treat+time&rdquo;</strong>： extending the number of students for each treatment at each time point</p>
<pre tabindex="0"><code># a power estimate at the increased sample size as well as a power curve that combines estimates at different sample sizes

sim_treat_subj &lt;- powerSim(model_ext_subj, nsim=100, test = fcompare(y~time))

sim_treat_subj


# visualization

p_curve_treat &lt;- powerCurve(model_ext_subj, test=fcompare(y~time), within=&#34;class+treat+time&#34;, breaks=c(5,10,15,20))
plot(p_curve_treat)
</code></pre><ul>
<li>Changing number of classes and participants per class</li>
</ul>
<p>We may want to study models with changes to <strong>multiple sample size</strong> components. The relevant changes can be applied to the model successively.</p>
<pre tabindex="0"><code>model_final &lt;- extend(model, along=&#34;class&#34;, n=8)

model_final &lt;- extend(model_final, within=&#34;class+treat+time&#34;, n=20)

sim_final &lt;- powerSim(model_final, nsim=100, test = fcompare(y~time))

sim_final
</code></pre><p>output:</p>
<pre tabindex="0"><code>Power for model comparison, (95% confidence interval):
      97.00% (91.48, 99.38)

Test: Likelihood ratio
      Comparison to y ~ time + [re]

Based on 100 simulations, (2 warnings, 0 errors)
alpha = 0.05, nrow = 960

Time elapsed: 0 h 0 m 28 s
</code></pre><p>以下为ZJ所加：</p>
<pre tabindex="0"><code># visualization

p_curve_final &lt;- powerCurve(model_final, nsim = 100, test=fcompare(y~time), within=&#34;class+treat+time&#34;, breaks=c(5,10,15,20))

plot(p_curve_final)
</code></pre><p>output:</p>
<pre tabindex="0"><code>Power for model comparison, (95% confidence interval),
by number of observations within class+treat+time:
      5: 72.00% (62.13, 80.52) - 240 rows
     10: 92.00% (84.84, 96.48) - 480 rows

Time elapsed: 0 h 0 m 34 s
</code></pre><h2 id="4-power-analysis-with-simr-for-multilevel-data">4. Power analysis with <code>simr</code> for multilevel data<a hidden class="anchor" aria-hidden="true" href="#4-power-analysis-with-simr-for-multilevel-data">#</a></h2>
<p><a href="https://rstudio-pubs-static.s3.amazonaws.com/484106_6b51212f20164fdd88cd7cce89bdef79.html">https://rstudio-pubs-static.s3.amazonaws.com/484106_6b51212f20164fdd88cd7cce89bdef79.html</a></p>
<p>Example study: - Pupils from different classes will be recruited.</p>
<ul>
<li>Pupil level predictor: extraversion (continuous)</li>
<li>Class level predictor: teacher experience  (continuous)</li>
<li>Outcome variable: pupil popularity  (continuous)</li>
</ul>
<pre tabindex="0"><code>library(lme4)
library(MonteCarlo)
library(dplyr)
library(ggplot2)
library(afex)
library(simr)
library(pwr)
library(broom) #extract random effects
library(knitr)
library(truncnorm)
</code></pre><pre tabindex="0"><code>data &lt;- read.delim(&#39;popular2.dat&#39;, header = TRUE, sep=&#34;&#34;, skip=2, as.is=TRUE)

#提取该数据集中第1、2、4、5、6、7列的数据
data&lt;-data[,c(1,2,4,5,6,7)]

#将这六列进行命名
names(data) &lt;- c(&#34;class&#34;,&#34;pupil&#34;,&#34;extrav&#34;,&#34;sex&#34;,&#34;texp&#34;,&#34;popular&#34;)

#计算gmc
# gmc的好处：Grand Mean Centering通过将每个观测值减去其所在变量的总均值，   
可以减少变量之间的相关性，从而减轻多重共线性的影响；通过将低层次变量进行总均值中心化，     
可以分离出低层次变量的组内变异（within-group variation）和组间变异   
（between-group variation），从而更准确地分析不同层次变量之间的交互作用。

df &lt;- data %##% 
  # Grand mean centering
  mutate(extrav.gmc = extrav-mean(extrav)) %##%
  mutate(texp.gmc = texp-mean(texp)) %&gt;%
  mutate(popular.gmc = popular-mean(popular))

#imagine we only have pilot data from 10 classes, we will create simulated model based on parameters from these pilot data.
#logic to select 10 classes in random

# set.seed(12345)
# class_unique&lt;-data.frame(unique(df$class))
# class_sample&lt;-sample_n(class_unique,20,replace=FALSE)
# 
# #logic to select all subjects in these classes
# df&lt;-df%&gt;%
#   filter(class %in% class_sample$unique.df.class.)

cols&lt;-c(&#39;class&#39;,&#39;pupil&#39;,&#34;sex&#34;)
data[cols]&lt;-lapply(data[cols],factor)

kable(head(df))
</code></pre><ul>
<li>Changing number of clusters while holding Ss per cluster = 10</li>
</ul>
<pre tabindex="0"><code>#logic to select 10 subjects from each of these randomly selected classes
set.seed(0)

df_10&lt;-df%&gt;%
  group_by(class)%&gt;%
  sample_n(size=10)
</code></pre><ul>
<li>Fit lmer model</li>
</ul>
<pre tabindex="0"><code>m&lt;-lmer(popular.gmc~extrav.gmc*texp.gmc+
                (1|class),df_10,REML=FALSE)

summary(m)
</code></pre><ul>
<li>Extract parameter estimates from lmer model</li>
</ul>
<pre tabindex="0"><code># parameters #1: fixed intercept and slope
fixed &lt;- c(-.0805,.4875,.1078,-.02224) 

# parameters #1: random intercept and slope variance-covariance matrix
# For class
rand &lt;-.4013

# parameters #3: Exrtact the residual sd  
# ^ 为幂运算，如8^ = 8 * 8 =64；^.5 = square root
s &lt;- .8824^.5 
</code></pre><ul>
<li>Create Simulated model using extracted parameters</li>
</ul>
<pre tabindex="0"><code>
model &lt;- makeLmer(y ~ extrav*texp + (1|class), fixef=fixed, VarCorr=rand, sigma=s, data=df_10)
model
</code></pre><p>output:</p>
<pre tabindex="0"><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]     
## Formula: y ~ extrav * texp + (1 | class)     
##    Data: df_10     
## REML criterion at convergence: 2911.247     
     
## Random effects:     
##  Groups   Name        Std.Dev.     
##  class    (Intercept) 0.6335       
     
##  Residual             0.9394       
## Number of obs: 1000, groups:  class, 100     
     
## Fixed Effects:     
## (Intercept)       extrav         texp  extrav:texp       
##    -0.08050      0.48750      0.10780     -0.02224     
</code></pre><ul>
<li>Changing the number of classes</li>
</ul>
<p>To study the effect <strong>an increase in sample size</strong> has on our ability to detect <strong>the effect of interest</strong> we can <strong>increase the number of levels for one of the factors</strong> in our model.</p>
<p>This can be achieved with the <strong><code>extend</code></strong> function.</p>
<p>For example, we could increase the number of classes from 10 to 50, this way we can do power analysis for any number of clusters that is less than 50.</p>
<pre tabindex="0"><code>model_ext_class &lt;- extend(model, along=&#34;class&#34;, n=50)   
model_ext_clas
</code></pre><ul>
<li>Power curve of <strong>pupil extraversion</strong></li>
</ul>
<p>Here we test how <strong>number of clusters(ZJ: grouping factor)</strong> effect the power of <strong>extraversion</strong> (one of the two fixed variables).</p>
<p>_以下code中请注意 test(), along 等arguments</p>
<pre tabindex="0"><code>set.seed(0)
p_curve_extrav &lt;- powerCurve(model_ext_class, 
                            test=fcompare(y~texp), 
                            along=&#34;class&#34;,
                            breaks=c(10,15,20,30,50),
                            nsim=500,alpha=.05, progress=FALSE)


# visualization
plot(p_curve_extrav)
</code></pre><p><img alt="power curve of number of classes (50) on the power of pupil extraversion" loading="lazy" src="/images/pupilextracurve.png" title="power curve of number of classes (50) on the power of pupil extraversion"></p>
<p>This curve represents the power estimations of pupil extraversion when <strong>nsize = 10 (&ldquo;10 subjects from each class&rdquo;) and cluster size varies</strong>.</p>
<p>We need <strong>at least 20 clusters(classes) of 10 (subjects) to have a power of at least 80% given the effect is present</strong>.</p>
<ul>
<li>Power curve of teacher experience</li>
</ul>
<p>Here we test how number of clusters (&ldquo;50&rdquo;) affect the power of teacher experience.</p>
<pre tabindex="0"><code>set.seed(0)
p_curve_texp &lt;- powerCurve(model_ext_class, 
                            test=fcompare(y~extrav), 
                            along=&#34;class&#34;,
                            breaks=c(10,15,20,30,50),
                            nsim=500,alpha=.05, progress=FALSE)

#visualization

plot(p_curve_texp)
</code></pre><p>output</p>
<p><img alt="power curve of number of classes (50) on the power of teacher experience" loading="lazy" src="/images/texpcurve.png" title="power curve of number of classes (50) on the power of teacher experience"></p>
<p>This curve represents the power estimations of the cross-level interaction between extraversion and teacher experience when <strong>nsize = 10 and cluster size varies</strong>.</p>
<p>We need <strong>at least 45 clusters(classes) of 10 (subjects) to have a power of at least 80% given the effect is present</strong>.</p>
<ul>
<li>Power curve of interaction between extraversion and teacher experience</li>
</ul>
<p>Here we test how number of clusters affect the power of inetaction between extravtion and teacher experience.</p>
<pre tabindex="0"><code>set.seed(0)
p_curve_interaction &lt;- powerCurve(model_ext_class, 
                            test=fcompare(y~texp+extrav), 
                            along=&#34;class&#34;,
                            breaks=c(10,15,20,30,50),
                            nsim=500,alpha=.05, progress=FALSE)
</code></pre><p>note: test = fcompare(y~texp+extrav)</p>
<p>output</p>
<p><img alt="power curve of number of classes (50) on the power of interaction between extraversion and teacher experience" loading="lazy" src="/images/extratexpcurve.png" title="power curve of number of classes (50) on the power of interaction between extraversion and teacher experience"></p>
<p>This curve represents the power estimations of the cross-level interaction between extraversion and teacher experience when nsize = 10 and cluster size varies.</p>
<p>We need <strong>at least 42 clusters of 10 to have a power of at least 80% given the effect is present</strong>.</p>
<ul>
<li>ZJ&rsquo;s summary (# of subject = 10)</li>
</ul>
<p>(1) for the variable of <strong>pupil exterversion</strong>, this factor reaches 80% of power when there are at least 20 classes, namely, 20 classes * 10 subjects/class = <strong>200 observations</strong>
(2) for the variable of <strong>teacher experience</strong>, this factor reaches 80% of power when there are at least 45 classes, namely, 45 classes * 10 subjects/class = <strong>450 observations</strong>
(3) for the <strong>interaction between pupil exterversion and teacher experience</strong>, this factor reaches 80% of power when there are at least 42 classes, namely, <strong>42 classes * 10 subjects/class = 420 observations</strong></p>
<ul>
<li>Changing number of clusters while holding Ss per cluster = 15</li>
</ul>
<pre tabindex="0"><code>#logic to select 10 subjects from each of these randomly selected classes
set.seed(0)

df_15&lt;-df%&gt;%
  group_by(class)%&gt;%
  sample_n(size=15)   #15 subjects from each class
</code></pre><p>&ndash; Fit lme model</p>
<pre tabindex="0"><code>m2&lt;-lmer(popular.gmc~extrav.gmc*texp.gmc+
                (1|class),df_15,REML=FALSE)

summary(m2)
</code></pre><p>note: here <code>gmc</code> is used</p>
<p>&ndash; Extract parameter estimates from lmer model</p>
<pre tabindex="0"><code># fixed intercept and slope
fixed2 &lt;- c(-.0655,.4794,.1071,-.02539) 

# random intercept and slope variance-covariance matrix
# For class
rand2 &lt;-.3682

# Exrtact the residual sd
s2 &lt;- .8908^.5 
</code></pre><p>&ndash; Create Simulated model using extracted parameters</p>
<pre tabindex="0"><code>model2 &lt;- makeLmer(y ~ extrav*texp + (1|class), fixef=fixed2, VarCorr=rand2, sigma=s2, data=df_15)
model2
</code></pre><p>&ndash; Changing the number of classes</p>
<pre tabindex="0"><code>model_ext_class2 &lt;- extend(model2, along=&#34;class&#34;, n=50)
model_ext_class2
</code></pre><p>&ndash; Power curve of pupil extraversion</p>
<pre tabindex="0"><code>set.seed(0)
p_curve_extrav2 &lt;- powerCurve(model_ext_class2, 
                            test=fcompare(y~texp), 
                            along=&#34;class&#34;,
                            breaks=c(10,15,20,30,50),
                            nsim=500,alpha=.05, progress=FALSE)


plot(p_curve_extrav2)
</code></pre><p>output
<img alt="power curve of number of classes (50) on the power of pupil extraversion when nsubject = 15" loading="lazy" src="/images/pupilextracurve2.png" title="power curve of number of classes (50) on the power of pupil extraversion when nsubject = 15"></p>
<p>This curve represents the power estimations of pupil extraversion when nsize = 15 and cluster size varies.</p>
<p>We need <strong>at least 15 clusters of 15 to have a power of at least 80% given the effect is present</strong>.</p>
<p>&ndash; Power curve of teacher experience</p>
<pre tabindex="0"><code>set.seed(0)
p_curve_texp2 &lt;- powerCurve(model_ext_class2, 
                            test=fcompare(y~extrav), 
                            along=&#34;class&#34;,
                            breaks=c(10,15,20,30,50),
                            nsim=500,alpha=.05, progress=FALSE)

plot(p_curve_texp2)
</code></pre><p>output:</p>
<p><img alt="power curve of number of classes (50) on the power of teacher experience when nsubject = 15" loading="lazy" src="/images/texpcurve2.png" title="power curve of number of classes (50) on the power of teacher experience when nsubject = 15"></p>
<p>This curve represents the power estimations of teacher experience when nsize = 15 and cluster size varies.</p>
<p>We need <strong>at least 18 clusters of 15 to have a power of at least 80% given the effect is present</strong>.</p>
<p>&ndash; Power curve of interaction between extraversion and teacher experience</p>
<pre tabindex="0"><code>set.seed(0)
p_curve_interaction2 &lt;- powerCurve(model_ext_class2, 
                            test=fcompare(y~texp+extrav), 
                            along=&#34;class&#34;,
                            breaks=c(10,15,20,30,50),
                            nsim=500,alpha=.05, progress=FALSE)

plot(p_curve_interaction2)
</code></pre><p>output:</p>
<p><img alt="power curve of number of classes (50) on the power of interaction between extraversion and teacher experience when nsubject = 15" loading="lazy" src="/images/extratexpcurve2.png" title="power curve of number of classes (50) on the power of interaction between extraversion and teacher experience when nsubject = 15"></p>
<p>This curve represents the power estimations of the cross-level interaction between extraversion and teacher experience when nsize = 15 and cluster size varies.</p>
<p>We need <strong>at least 20 clusters of 15 to have a power of at least 80% given the effect is present</strong>.</p>
<ul>
<li>ZJ&rsquo;s summary (# of subject = 15)</li>
</ul>
<p>(1) for the variable of <strong>pupil exterversion</strong>, this factor reaches 80% of power when there are at least 15 classes, namely, 15 classes * 15 subjects/class = <strong>225 observations</strong></p>
<p>(2) for the variable of <strong>teacher experience</strong>, this factor reaches 80% of power when there are at least 18 classes, namely, 18 classes * 15 subjects/class = <strong>270 observations</strong></p>
<p>(3) for the <strong>interaction between pupil exterversion and teacher experience</strong>, this factor reaches 80% of power when there are at least 20 classes, namely, <strong>20 classes * 15 subjects/class = 300 observations</strong></p>
<ul>
<li>conclusion <br>
We need <strong>at least 20 (clusters) x 15 (Ss/cluster) = 300 observations</strong> to detect all 3 effects (extrav, texp, extrav x texp) given that all 3 effects exist in the population.</li>
</ul>
<p>===============================================================</p>
<p><em>The following is a walk-through based on my own studies.</em></p>
<h2 id="5-power-analysis-with-actual-datasets-from-my-own-study">5. Power analysis with actual datasets from my own study<a hidden class="anchor" aria-hidden="true" href="#5-power-analysis-with-actual-datasets-from-my-own-study">#</a></h2>
<p>Study #1: response elicitation</p>
<ol>
<li>overview of the study</li>
</ol>
<p>independent variables:<br>
two within-subjects variables (A &amp; B), each with 2 levels (A1, A2, B1, B2)
four conditions</p>
<p>dependent variable:<br>
counts of responses (6 types in total based on the pilot study)
(types of responses that participants give in different conditions)</p>
<ol start="2">
<li>
<p>pilot dataset
50 subjects</p>
</li>
<li>
<p>fit a model for count data</p>
</li>
</ol>
<p>Based on the types of variables, multinomial logistic models should be used.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Jun Zhang</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
